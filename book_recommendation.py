# -*- coding: utf-8 -*-
"""book recommendation.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/11vRW_TtijjBJyOky6q4pzCIVBkjGJIF-

# Import
"""

!pip install surprise

import pandas as pd
import numpy as np
import gzip
import seaborn as sns
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import cosine_similarity 
from sklearn.preprocessing import LabelEncoder
from surprise import Reader, Dataset, SVD
from surprise.model_selection import cross_validate
import re
import random
import zipfile,os

"""# Data loading

download [Book Recommendation Dataset](https://www.kaggle.com/arashnic/book-recommendation-dataset) dengan kaggle API
"""

from google.colab import files

uploaded = files.upload()

for fn in uploaded.keys():
  print('User uploaded file "{name}" with length {length} bytes'.format(
      name=fn, length=len(uploaded[fn])))

# Then move kaggle.json into the folder where the API expects to find it.
!mkdir -p ~/.kaggle/ && mv kaggle.json ~/.kaggle/ && chmod 600 ~/.kaggle/kaggle.json

!kaggle datasets download -d arashnic/book-recommendation-dataset

local_zip = 'book-recommendation-dataset.zip'
zip_ref = zipfile.ZipFile(local_zip, 'r')
zip_ref.extractall()
zip_ref.close()

"""# EDA

## Books
menganalisis karakteristik data buku
"""

books_df = pd.read_csv('Books.csv')
books_df

books_df.info()

"""terdapat beberapa null value pada data buku (author, publisher, Image-URL-L), dan beberapa judul duplikat karena jumlah judul dan ISBN tidak sama, maka perlu dilakukan proses handling missing value dan drop duplicate pada data preparation"""

print('Jumlah ISBN:', len(books_df.ISBN.unique()))
print('Jumlah judul:', len(books_df['Book-Title'].unique()))
print('Jumlah author:', len(books_df['Book-Author'].unique()))
print('Jumlah publisher:', len(books_df['Publisher'].unique()))

"""## Rating

menganalisis karakteristik data rating

---


"""

ratings_df = pd.read_csv('Ratings.csv')
ratings_df

ratings_df.info()

ratings_df['Book-Rating'].describe()

print('Jumlah user:', len(ratings_df['User-ID'].unique()))
print('Jumlah buku:', len(ratings_df['ISBN'].unique()))
print('Jumlah rating diterima:', len(ratings_df))

with sns.axes_style('white'):
    g = sns.catplot("Book-Rating", data=ratings_df, aspect=2.0, kind='count')
    g.set_ylabels("Total number of ratings")

"""dari plot jumlah rating, banyak buku yang memiliki rating 0, untuk mengurangi bias, data tersebut dapat dihapus

## Users

analisis karakteristik data user
"""

users_df = pd.read_csv('Users.csv')
users_df

"""terdapat banyak missing value pada kolom Age, maka perlu dilakukan handling missing value pada kolom age di proses data preparation"""

users_df.info()

"""# Data preparation

## Books

menyeleksi fitur yang diperlukan
"""

books = books_df[['ISBN', 'Book-Title','Book-Author', 'Publisher']]
books.head()

# check missing value in books
books.isnull().sum()

"""mengisi data kosong pada publisher dan author"""

# fill missing value in Book Author and Publisher
books.loc[:,'Book-Author'] = books['Book-Author'].fillna('Unknown')
books.loc[:,'Publisher'] = books['Publisher'].fillna('Unknown')
books.isnull().sum()

"""## Ratings"""

ratings = ratings_df
ratings.isnull().sum()

print('Jumlah rating 0 :', ratings['Book-Rating'].eq(0).sum())
ratings.shape

"""menghapus data rating 0"""

ratings = ratings[ratings['Book-Rating']>0]
ratings.shape

with sns.axes_style('white'):
    g = sns.catplot("Book-Rating", data=ratings, aspect=2.0, kind='count')
    g.set_ylabels("Total number of ratings")

"""## Users"""

users = users_df
users.isnull().sum()

"""terdapat banyak sekali missing value pada kolom Age, dan tidak mungkin kita menghapus user yang tidak memiliki umur, sehingga missing value dapat diisi dengan modus dari Age, yaitu 24 tahun"""

users['Age'] = users['Age'].fillna(users['Age'].mode())
users.isnull().sum()

users['Age'].hist(bins=50)

"""menggabungkan data buku dan rating"""

book_rating = pd.merge(ratings, books, on=['ISBN'],)
book_rating.head()

"""# Popularity based recommendation

merekomendasikan buku paling populer berdasarkan rata rata rating dan jumlah rating yang diterima

## By rating average
"""

book_average_rating = book_rating.groupby('ISBN')['Book-Rating'].mean().sort_values(ascending=False)
book_average_rating

"""berdasarkan plot, terdapat lebih dari 20000 buku yang memiliki rating tertinggi, maka tidak bisa merekomendasikan 20 buku terbaik hanya berdasarkan rata-rata rating saja"""

book_average_rating.hist(bins=50)

book_average_rating.head(20).plot(kind='barh')

"""## By amount rating received

diperlukan informasi lain untuk merekomendasikan buku terbaik, dapat menggunakan jumlah rating yang diterima tiap buku
"""

# recommend product by rating received
book_popularity_count = book_rating.groupby('ISBN')['Book-Rating'].count().sort_values(ascending=False)
book_popularity_count

book_popularity_count.hist(bins=50)

book_popularity_count.head(20).sort_values().plot(kind='barh',
                                                  title='Most Rating Received per Book')

"""## Weighted rating

untuk menggabungkan kedua informasi, dibuatlah weighted rating berdasarkan rata-rata rating dan jumlah rating diterima, kemudian memilih 20 produk terbaik berdasarkan weighted rating

![weighted rating.JPG](data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4RDyRXhpZgAATU0AKgAAAAgABAE7AAIAAAANAAAISodpAAQAAAABAAAIWJydAAEAAAAaAAAQ0OocAAcAAAgMAAAAPgAAAAAc6gAAAAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEluYXlhaCBTdXJ5YQAAAAWQAwACAAAAFAAAEKaQBAACAAAAFAAAELqSkQACAAAAAzAzAACSkgACAAAAAzAzAADqHAAHAAAIDAAACJoAAAAAHOoAAAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAyMDIxOjA5OjI2IDIzOjU3OjMxADIwMjE6MDk6MjYgMjM6NTc6MzEAAABJAG4AYQB5AGEAaAAgAFMAdQByAHkAYQAAAP/hCx9odHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvADw/eHBhY2tldCBiZWdpbj0n77u/JyBpZD0nVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkJz8+DQo8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIj48cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPjxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSJ1dWlkOmZhZjViZGQ1LWJhM2QtMTFkYS1hZDMxLWQzM2Q3NTE4MmYxYiIgeG1sbnM6ZGM9Imh0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvIi8+PHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9InV1aWQ6ZmFmNWJkZDUtYmEzZC0xMWRhLWFkMzEtZDMzZDc1MTgyZjFiIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iPjx4bXA6Q3JlYXRlRGF0ZT4yMDIxLTA5LTI2VDIzOjU3OjMxLjAzNDwveG1wOkNyZWF0ZURhdGU+PC9yZGY6RGVzY3JpcHRpb24+PHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9InV1aWQ6ZmFmNWJkZDUtYmEzZC0xMWRhLWFkMzEtZDMzZDc1MTgyZjFiIiB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iPjxkYzpjcmVhdG9yPjxyZGY6U2VxIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+PHJkZjpsaT5JbmF5YWggU3VyeWE8L3JkZjpsaT48L3JkZjpTZXE+DQoJCQk8L2RjOmNyZWF0b3I+PC9yZGY6RGVzY3JpcHRpb24+PC9yZGY6UkRGPjwveDp4bXBtZXRhPg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8P3hwYWNrZXQg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)

dimana

v = jumlah rating diterima

R = rata-rata rating per produk

C = rata-rata rating seluruh produk

m = minimal jumlah rating yang diterima
"""

popular_recommendation = pd.concat([book_average_rating, book_popularity_count],
                                   axis=1, join='inner',
                                   keys=['Average Rating', 'Rating Received'])

v = popular_recommendation['Rating Received'] # jumlah rating diterima
R = popular_recommendation['Average Rating'] # rata-rata rating per produk
C = popular_recommendation['Average Rating'].mean() # rata-rata rating seluruh produk
m = popular_recommendation['Rating Received'].quantile(0.75) # minimal jumlah rating yang diterima

popular_recommendation['Weighted Rating'] = ((R*v)+(C*m))/(v+m)
popular_recommendation = popular_recommendation.sort_values('Weighted Rating', ascending=False)
popular_recommendation.head(20)

"""hasil rekomendasi dengan weighted rating"""

popular_title = pd.merge(popular_recommendation, books[['ISBN', 'Book-Title']],
                         on='ISBN')
popular_title = popular_title[['Weighted Rating', 'Book-Title']]
popular_title = popular_title.drop_duplicates('Book-Title').set_index('Book-Title')
popular_title.head(20)

"""plot hasil rekomendasi berdasarkan weighter rating"""

popular_title['Weighted Rating'].head(20).sort_values().plot(kind='barh', figsize=(15,8),
                                                             title='Most Popular Book by Rating')

"""# Content-based recommendation

Merekomendasikan buku berdasarkan book author

data buku yang sangat banyak (271360 buku) perlu menggunakan resource RAM yang sangat besar pula, maka kita dapat menyeleksi 10000 buku terbaik berdasarkan rekomendasi buku terpopuler sebelumnya untuk direkomendasikan
"""

sorted_books = pd.DataFrame(popular_recommendation.index, columns=['ISBN'])
content_df = pd.merge(sorted_books, books, on='ISBN')
content_df = content_df.drop_duplicates('Book-Title').head(10000)
content_df

"""## TF-IDF vectorizer

melakukan transformasi book author menjadi matrix dengan TF-IDF Vectorizer
"""

tfidf = TfidfVectorizer()
tfidf_matrix = tfidf.fit_transform(content_df['Book-Author'])
tfidf_matrix.shape

"""## Cosine similarity

mencari kesamaan antar buku berdasarkan authornya dengan cosine similarity
"""

cosine_sim = cosine_similarity(tfidf_matrix)
cosine_sim

# Membuat dataframe dari variabel cosine_sim 
# dengan baris dan kolom berupa nama resto
cosine_sim_df = pd.DataFrame(cosine_sim, index=content_df['Book-Title'],
                             columns=content_df['Book-Title'])
print('Shape:', cosine_sim_df.shape)

# Melihat similarity matrix pada setiap resto
cosine_sim_df.sample(10, axis=1).sample(10, axis=0)

"""## Book recommendation"""

def book_recommendations(book_title, similarity_data=cosine_sim_df, 
                         items=content_df[["Book-Title","Book-Author"]], k=10):
    """
    Rekomendasi Resto berdasarkan kemiripan dataframe
 
    Parameter:
    ---
    book_title : tipe data string (str)
                Judul Buku (index kemiripan dataframe)
    similarity_data : tipe data pd.DataFrame (object)
                      Kesamaan dataframe, simetrik, dengan buku sebagai 
                      indeks dan kolom
    items : tipe data pd.DataFrame (object)
            Mengandung kedua nama dan fitur lainnya yang digunakan untuk mendefinisikan kemiripan
    k : tipe data integer (int)
        Banyaknya jumlah rekomendasi yang diberikan
    ---
    Pada index ini, kita mengambil k dengan nilai similarity terbesar 
    pada index matrix yang diberikan (i).
    """

    # Mengambil data dengan menggunakan argpartition untuk melakukan 
    # partisi secara tidak langsung sepanjang sumbu yang diberikan    
    # Dataframe diubah menjadi numpy
    # Range(start, stop, step)
    index = similarity_data.loc[:, book_title].to_numpy().argpartition(
        range(-1, -k, -1)
    )

    # Mengambil data dengan similarity terbesar dari index yang ada
    closest = similarity_data.columns[index[-1:-(k+2):-1]]

    # Drop book_title agar judul buku yang dicari 
    # tidak muncul dalam daftar rekomendasi
    closest = closest.drop(book_title, errors='ignore')

    return pd.DataFrame(closest).merge(items).head(k)

"""merekomendasikan buku lain berdasarkan author dari buku tertentu"""

book_title = 'Harry Potter and the Goblet of Fire'
book_recom = book_recommendations(book_title)
recom_rating = pd.merge(book_recom, popular_title, on='Book-Title')
recom_rating

"""# Collaborative filtering (model based) recommendation
Merekomendasikan buku lain kepada user yang memberi rating buku
"""

user_rating = book_rating
user_rating

"""## Label encoding

encoder User ID dan Book Title
"""

le = LabelEncoder()
user_rating['UserID'] = le.fit_transform(user_rating['User-ID'])
user_rating['TitleID'] = le.fit_transform(user_rating['Book-Title'])
user_rating.drop('User-ID', axis=1, inplace=True)
user_rating

"""## Model development

Mentraining data user buku dengan model SVD dari library surprise dan mengevaluasi dengan 5-fold cross validation menggunakan matriks RMSE dan MAE. evaluasi model dengan test set pada 5 fold menghasilkan rata-rata RMSE 1.64, rata-rata MAE 1.27
"""

reader = Reader(rating_scale=(1, 10))
data = Dataset.load_from_df(user_rating[['UserID', 'TitleID', 'Book-Rating']],
                            reader)
svd = SVD(verbose=False, n_epochs=10)
cross_validate(svd, data, measures=['RMSE', 'MAE'], cv=5, verbose=True)

"""## Merekomendasikan buku berdasarkan riwayat rating user

prediksi rating buku dengan model SVD, kemudian mengurutkan 10 buku dengan prediksi rating tertinggi
"""

def user_recommendation(userid):
    user = user_rating[['ISBN', 'Book-Title', 'Book-Author', 'Publisher', 'TitleID']]
    user = user.reset_index()
    # getting full dataset
    data = Dataset.load_from_df(user_rating[['UserID','TitleID','Book-Rating']], reader)
    trainset = data.build_full_trainset()
    svd.fit(trainset)
    user['Estimate_Score'] = user['TitleID'].apply(lambda x: svd.predict(userid, x).est)
    user = user.drop(['index','TitleID'], axis = 1)
    user = user.sort_values('Estimate_Score' , ascending = False)
    counts1 = user['Estimate_Score'].value_counts()
    user = user[user['Estimate_Score'].isin(counts1[counts1 == 1].index)]
    return user.head(10)

"""merekomendasikan buku lain kepada user yang memberi rating pada buku Harry Potter"""

# mencari user yang menyukai buku Harry Potter sebagai contoh
user_rating[user_rating['Book-Title'].str.contains('Harry Potter')]

user_id = 60216

print('User telah merating buku :')
user_rating[user_rating['UserID'].eq(user_id)]

print('Rekomendasi buku yang mungkin disukai user')
user_recommendation(user_id)